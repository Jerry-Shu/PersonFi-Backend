<!doctype html>
<meta charset="utf-8" />
<title>PersonFi — Analyze & Img2Img</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial;margin:32px;max-width:900px}
  #out{white-space:pre-wrap;background:#0f172a;color:#e2e8f0;padding:12px;border-radius:8px}
  .row{display:flex;gap:12px;margin:12px 0;align-items:center}
  .btn{padding:8px 14px;border:1px solid #cbd5e1;border-radius:8px;background:#f8fafc;cursor:pointer}
  textarea{width:100%;height:90px;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
  select{padding:6px;border:1px solid #cbd5e1;border-radius:8px}
  #imgwrap{margin-top:16px}
  #resultImg{max-width:100%;border:1px solid #e5e7eb;border-radius:8px}
</style>

<h1>PersonFi — Clothing Analysis (JSON) & Image + Prompt Generation</h1>

<div class="row">
  <input id="file" type="file" accept="image/*" />
  <button class="btn" id="btnAnalyze">Analyze (JSON)</button>
</div>

<pre id="out"></pre>

<hr style="margin:24px 0">

<h2>Image + Prompt Generation</h2>
<div class="row" style="flex-direction:column;align-items:stretch">
  <textarea id="prompt" placeholder="e.g.: a burgundy blazer isolated on transparent background, realistic e-commerce photo"></textarea>
  <div class="row" style="justify-content:space-between">
    <div>
      Size:
      <select id="size">
        <option>1024x1024</option>
        <option>768x768</option>
        <option>512x512</option>
        <option>256x256</option>
      </select>
    </div>
    <button class="btn" id="btnImg2Img">Generate from Prompt + Image</button>
  </div>
</div>

<div id="imgwrap" style="display:none">
  <h3>Result</h3>
  <img id="resultImg" alt="img2img result"/>
</div>

<script>
const $ = id => document.getElementById(id);

async function postFile(url){
  const f = $("file").files[0];
  if (!f) throw new Error("Please select an image");
  const fd = new FormData();
  fd.append("file", f);
  const res = await fetch(url, { method:"POST", body: fd });
  const txt = await res.text();
  let data = null;
  try { data = JSON.parse(txt); } catch {}
  return { raw: txt, data };
}

$("btnAnalyze").onclick = async () => {
  $("imgwrap").style.display = "none"; $("resultImg").src = ""; $("out").textContent = "";
  try {
    const {raw, data} = await postFile("http://127.0.0.1:8000/analyze");
    $("out").textContent = data ? JSON.stringify(data, null, 2) : raw;
  } catch (e) {
    $("out").textContent = "Request failed: " + e;
  }
};

$("btnImg2Img").onclick = async () => {
  const f = $("file").files[0];
  if (!f) return alert("Please choose an image first");
  const prompt = $("prompt").value.trim();
  if (!prompt) return alert("Please fill the Prompt");
  const size = $("size").value;

  const fd = new FormData();
  fd.append("file", f);
  fd.append("prompt", prompt);
  fd.append("size", size);

  $("out").textContent = ""; $("imgwrap").style.display = "none"; $("resultImg").src = "";

  try {
    const res = await fetch("http://127.0.0.1:8000/img2img", { method: "POST", body: fd });
    const txt = await res.text();
    let data = null;
    try { data = JSON.parse(txt); } catch {}
    if (!data || !data.image_png_base64) { $("out").textContent = data ? JSON.stringify(data, null, 2) : txt; return; }
    $("imgwrap").style.display = "block";
    $("resultImg").src = "data:image/png;base64," + data.image_png_base64;
  } catch (e) {
    $("out").textContent = "Request failed: " + e;
  }
};
</script>
